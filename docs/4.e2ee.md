# 4. 端到端加密

## 4.1 简单端到端加密

```mermaid
sequenceDiagram
  A ->>+ Server: 请求 B 的证书和公钥 B_pk
  Server -->>- A: 返回结果
  Note over A: 验证 B 的身份
  Note over A: 生成随机对称加密密钥 K
  Note over A: 使用 B 的公钥 B_pk 加密 K 得到 E_K
  Note over A: 对密钥 K 进行签名得到 S_K
  A ->>+ Server: 发送 E_K 和 S_K
  Server -->>- A: 确认服务器存储认证信息
  Note over A,B: 等待 B 的连接
  B ->>+ Server: 请求 A 的证书、公钥 A_pk 和验证信息
  Server -->>- B: 返回结果
  Note over B: 验证 A 的身份
  Note over B: 使用自己的私钥解密 E_K 得到 K
  Note over B: 使用 A 的公钥验证 S_K
  B ->>+ Server: 通知服务器确认信息
  Server -->>- B: 返回
  Note over A,B: 使用对称加密密钥 K 进行
  B ->>+ Server: 发送测试数据
  Server ->>+ A: 服务器转发数据
  A -->>- Server: 确认测试数据
  Server -->>- B: 服务器转发数据
```
